generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id          String   @id @default(uuid())
  name        String
  type        AgentType
  role        String
  scope       String?
  sources     String[]
  config      Json?
  status      AgentStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  projects    ProjectAgent[]
  simulations Simulation[]
  debates     Debate[]

  @@index([type, status])
}

enum AgentType {
  SUPERVISOR
  SIMULATION
  DEBATE
  AGGREGATOR
  PROPAGANDA
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  city        String?
  region      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  agents      ProjectAgent[]
  policyDocs  PolicyDocument[]
  simulations Simulation[]
  reports     Report[]

  @@index([createdAt])
}

model ProjectAgent {
  id        String   @id @default(uuid())
  projectId String
  agentId   String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  agent     Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, agentId])
  @@index([projectId])
}

model PolicyDocument {
  id          String   @id @default(uuid())
  projectId   String
  filename    String
  filepath    String
  extractedText String?
  parsedActions Json?
  uploadedAt  DateTime @default(now())
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  simulations Simulation[]

  @@index([projectId])
}

model Simulation {
  id              String   @id @default(uuid())
  projectId       String
  agentId         String
  policyDocId     String?
  city            String
  region          String?
  parameters      Json
  status          SimulationStatus @default(PENDING)
  results         Json?
  metrics         Json?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  agent           Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  policyDoc       PolicyDocument? @relation(fields: [policyDocId], references: [id], onDelete: SetNull)
  debates         Debate[]
  reports         Report[]

  @@index([projectId, status])
  @@index([createdAt])
}

enum SimulationStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model Debate {
  id            String   @id @default(uuid())
  simulationId  String
  agentId       String
  arguments     Json
  sentiment     Json?
  riskScores    Json?
  createdAt     DateTime @default(now())
  
  simulation    Simulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  agent         Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([simulationId])
}

model Report {
  id              String   @id @default(uuid())
  projectId       String
  simulationId    String?
  title           String
  content         Json
  format          ReportFormat
  exportUrl       String?
  generatedAt     DateTime @default(now())
  
  project         Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  simulation      Simulation? @relation(fields: [simulationId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([generatedAt])
}

enum ReportFormat {
  PDF
  POWERPOINT
  HTML
  MARKDOWN
}

model StreamEvent {
  id          String   @id @default(uuid())
  sessionId   String
  agentType   String
  eventType   String
  data        Json
  timestamp   DateTime @default(now())

  @@index([sessionId, timestamp])
  @@index([timestamp])
}


